<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QMT Server - 股票交易策略管理 v1.0</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 Bootstrap Icons -->
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- 引入自定义样式 -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        .strategy-card {
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .strategy-time {
            font-size: 0.9rem;
            color: #666;
        }
        .buy-action {
            color: #d9534f;
            font-weight: bold;
        }
        .add-action {
            color: #d9534f;
            font-weight: bold;
            opacity: 0.8;
        }
        .sell-action {
            color: #5cb85c;
            font-weight: bold;
        }
        .trim-action {
            color: #5cb85c;
            font-weight: bold;
            opacity: 0.8;
        }
        .hold-action {
            color: #f0ad4e;
            font-weight: bold;
        }
        .inactive-strategy {
            opacity: 0.6;
        }
        .active-strategy {
            border-left: 4px solid #28a745;
        }
        .strategy-card {
            margin-bottom: 1rem;
        }
        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .strategy-time {
            font-size: 0.9rem;
            color: #666;
        }
        .buy-action {
            color: #d9534f;
            font-weight: bold;
        }
        .add-action {
            color: #d9534f;
            font-weight: bold;
            opacity: 0.8;
        }
        .sell-action {
            color: #5cb85c;
            font-weight: bold;
        }
        .trim-action {
            color: #5cb85c;
            font-weight: bold;
            opacity: 0.8;
        }
        .hold-action {
            color: #f0ad4e;
            font-weight: bold;
        }
        .success-result {
            color: #5cb85c;
        }
        .failed-result {
            color: #d9534f;
        }
        .partial-result {
            color: #f0ad4e;
        }
        .search-panel {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .nav-tabs {
            margin-bottom: 1rem;
        }
        .execution-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .execution-item {
            border-left: 3px solid #ddd;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            background: #fff;
        }
        .execution-item:hover {
            border-left-color: #0d6efd;
            background: #f8f9fa;
        }
        .execution-time {
            font-size: 0.85rem;
            color: #666;
        }
        .btn-execute {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        /* 执行状态进度条样式 */
        .execution-status {
            width: 100%;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            background-color: #f5f5f5;
            margin: 5px 0;
        }
        
        .execution-status-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
        }
        
        .status-pending {
            background-color: #ffc107;
            width: 0%;
        }
        
        .status-partial {
            background-color: #17a2b8;
            width: 50%;
        }
        
        .status-completed {
            background-color: #28a745;
            width: 100%;
        }

        /* 持仓卡片样式 */
        .position-card {
            margin-bottom: 1rem;
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .profit {
            color: #d81e06;
        }

        .loss {
            color: #1aad19;
        }

        .position-details {
            font-size: 0.9rem;
        }

        .position-value {
            font-weight: bold;
        }

        .position-time {
            font-size: 0.8rem;
            color: #666;
        }

        .position-card .card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            transition: box-shadow 0.3s ease-in-out;
        }

        .execution-card {
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            border-left: 3px solid #ddd;
        }
        .execution-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left-color: #0d6efd;
        }
        .execution-info {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem 1rem;
            font-size: 0.9rem;
            color: #666;
        }
        .execution-info > div {
            margin: 0;
        }
        .execution-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .execution-title h5 {
            margin: 0;
            font-size: 1rem;
        }
        .execution-result {
            font-weight: bold;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
        }
        .result-success {
            background-color: #d4edda;
            color: #155724;
        }
        .result-failed {
            background-color: #f8d7da;
            color: #721c24;
        }
        .result-partial {
            background-color: #fff3cd;
            color: #856404;
        }
        .execution-remarks {
            margin-top: 0.5rem;
            font-style: italic;
            color: #666;
            font-size: 0.85rem;
        }
        .last-update-time {
            font-size: 0.8rem;
            color: #666;
        }
        .refresh-btn {
            margin-bottom: 1rem;
        }
        .total-row {
            font-weight: bold;
            background-color: #f8f9fa;
        }
        .position-table th {
            white-space: nowrap;
            background-color: #f8f9fa;
        }
        .position-table td {
            white-space: nowrap;
        }
        .table-responsive {
            margin-bottom: 2rem;
        }
        /* 添加新的操作类型样式 */
        .execution-buy {
            border-left: 4px solid #d9534f;
        }
        .execution-add {
            border-left: 4px solid #d9534f;
            border-left-style: dashed;
        }
        .execution-sell {
            border-left: 4px solid #5cb85c;
        }
        .execution-trim {
            border-left: 4px solid #5cb85c;
            border-left-style: dashed;
        }
        .execution-hold {
            border-left: 4px solid #f0ad4e;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="text-center mb-4">AI-Stock</h1>
        
        <!-- 导航标签 -->
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#positions" type="button">持仓管理</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#strategies" type="button">策略管理</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#executions" type="button">执行记录</button>
            </li>
        </ul>
        
        <!-- 标签内容 -->
        <div class="tab-content">
            <!-- 持仓管理标签 -->
            <div class="tab-pane fade show active" id="positions">
                <!-- 持仓列表工具栏 -->
                <div class="row mb-4 mt-4">
                    <div class="col">
                        <div class="d-flex justify-content-between align-items-center">
                            <button class="btn btn-outline-primary" onclick="refreshPositions()">
                                <i class="bi bi-arrow-clockwise"></i> 刷新持仓
                            </button>
                            <div class="text-end">
                                <span class="text-muted">最后更新时间：</span>
                                <span id="lastUpdateTime"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 持仓列表 -->
                <div id="positionsList" class="row">
                    <!-- 资金信息面板 -->
                    <div class="fund-info-panel mb-4">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">可用资金</h5>
                                        <p class="card-text" id="availableFunds">¥ 0.00</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">资产总值</h5>
                                        <p class="card-text" id="totalAssets">¥ 0.00</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">总收益率</h5>
                                        <p class="card-text" id="totalProfitRatio">0.00%</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="position-table-container">
                        <table class="position-table">
                            <thead>
                                <tr>
                                    <th>股票名称</th>
                                    <th>股票代码</th>
                                    <th>持仓数量</th>
                                    <th>原始成本</th>
                                    <th>动态成本</th>
                                    <th>最新价格</th>
                                    <th>持仓成本</th>
                                    <th>持仓市值</th>
                                    <th>浮动盈亏</th>
                                    <th>盈亏比例</th>
                                </tr>
                            </thead>
                            <tbody id="positionsTableBody">
                                <!-- 持仓数据将通过 JavaScript 动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 策略管理标签 -->
            <div class="tab-pane fade" id="strategies">
                <!-- 搜索面板 -->
                <div class="search-panel">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="searchStockCode" placeholder="股票代码">
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="searchStockName" placeholder="股票名称">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="searchAction">
                                <option value="">交易动作</option>
                                <option value="buy">买入</option>
                                <option value="sell">卖出</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="searchStatus">
                                <option value="true">有效策略</option>
                                <option value="false">失效策略</option>
                                <option value="">全部策略</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="datetime-local" class="form-control" id="searchStartTime" placeholder="开始时间">
                        </div>
                        <div class="col-md-4">
                            <input type="datetime-local" class="form-control" id="searchEndTime" placeholder="结束时间">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" onclick="searchStrategies()">
                                <i class="bi bi-search"></i> 搜索策略
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 策略列表工具栏 -->
                <div class="row mb-4">
                    <div class="col">
                        <div class="d-flex justify-content-between align-items-items-center">
                            <div>
                                <button class="btn btn-outline-primary me-2" onclick="refreshStrategies()">
                                    <i class="bi bi-arrow-clockwise"></i> 刷新列表
                                </button>
                            </div>
                            <button class="btn btn-success" onclick="showCreateStrategyModal()">
                                <i class="bi bi-plus-lg"></i> 新建策略
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 策略列表 -->
                <div id="strategiesList" class="row">
                    <!-- 策略列表将通过 JavaScript 动态加载 -->
                </div>
            </div>
            
            <!-- 执行记录标签 -->
            <div class="tab-pane fade" id="executions" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button class="btn btn-primary refresh-btn" onclick="refreshExecutions()">
                        <i class="bi bi-arrow-clockwise"></i> 刷新数据
                    </button>
                    <small class="last-update-time">最后更新时间：<span id="executionLastUpdateTime">-</span></small>
                </div>
                <div id="executionsList"></div>
            </div>
        </div>
    </div>

    <!-- 新建策略模态框 -->
    <div class="modal fade" id="createStrategyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新建策略</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createStrategyForm">
                        <div class="mb-3">
                            <label class="form-label">策略文本</label>
                            <textarea class="form-control" id="strategyText" rows="3" required></textarea>
                            <div class="form-text">请输入自然语言的策略描述，例如："以30元买入平安银行，仓位30%"</div>
                        </div>
                    </form>
                </div>
                <div class="mb-3">
                    <label for="analysisResult" class="form-label">分析结果：</label>
                    <pre id="analysisResult" class="form-control" style="min-height: 200px;"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="analyzeStrategyBtn" onclick="analyzeStrategy()">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        分析策略
                    </button>
                    <button type="button" class="btn btn-success d-none" id="createStrategyBtn" onclick="createStrategy()">
                        确认创建
                    </button>
                    <button type="button" class="btn btn-warning d-none" id="updateStrategyBtn" onclick="updateAnalyzedStrategy()">
                        确认更新
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 执行策略模态框 -->
    <div class="modal fade" id="executeStrategyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">执行策略</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="executeStrategyForm">
                        <input type="hidden" id="executeStrategyId">
                        <div class="mb-3">
                            <label class="form-label">执行价格</label>
                            <input type="number" class="form-control" id="executionPrice" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">交易量</label>
                            <input type="number" class="form-control" id="executionVolume" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">执行状态</label>
                            <select class="form-select" id="executionStatus" required>
                                <option value="">请选择执行状态</option>
                                <option value="partial">部分执行</option>
                                <option value="completed">全部完成</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">备注说明</label>
                            <textarea class="form-control" id="executionRemarks" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="executeStrategy()">确认执行</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改策略模态框 -->
    <div class="modal fade" id="editStrategyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">修改策略</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStrategyForm">
                        <input type="hidden" id="editStrategyId">
                        <div class="mb-3">
                            <label class="form-label">股票名称</label>
                            <input type="text" class="form-control" id="editStockName" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">股票代码</label>
                            <input type="text" class="form-control" id="editStockCode" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">交易动作</label>
                            <input type="text" class="form-control" id="editAction" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">仓位比例</label>
                            <input type="number" class="form-control" id="editPositionRatio" step="1" min="0" max="100" required>
                            <div class="form-text">请输入0-100之间的整数，表示百分比</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">价格区间</label>
                            <div class="row">
                                <div class="col">
                                    <input type="number" class="form-control" id="editPriceMin" step="0.01" placeholder="最小价格">
                                </div>
                                <div class="col">
                                    <input type="number" class="form-control" id="editPriceMax" step="0.01" placeholder="最大价格">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">止盈止损</label>
                            <div class="row">
                                <div class="col">
                                    <input type="number" class="form-control" id="editTakeProfitPrice" step="0.01" placeholder="止盈价">
                                </div>
                                <div class="col">
                                    <input type="number" class="form-control" id="editStopLossPrice" step="0.01" placeholder="止损价">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">其他条件</label>
                            <textarea class="form-control" id="editOtherConditions" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">操作理由</label>
                            <textarea class="form-control" id="editReason" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="updateStrategy()">保存修改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 详细错误信息模态框 -->
    <div class="modal fade" id="detailedErrorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="errorModalTitle">错误详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="errorModalBody">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    </div>
</div>

<!-- 引入必要的 JavaScript 库 -->
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/js/bootstrap.bundle.min.js" 
        onerror="reportLoadError('Bootstrap JS')"></script>
<!-- 引入 Axios -->
<script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.2/axios.min.js"
        onerror="reportLoadError('Axios JS')"></script>
<!-- 备用资源 -->
<script>
    // 如果主要资源加载失败，尝试备用资源
    if (typeof bootstrap === 'undefined') {
        console.warn('尝试加载备用 Bootstrap 资源');
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js';
        script.onerror = function() { reportLoadError('备用 Bootstrap JS'); };
        document.body.appendChild(script);
    }
    
    if (typeof axios === 'undefined') {
        console.warn('尝试加载备用 Axios 资源');
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js';
        script.onerror = function() { reportLoadError('备用 Axios JS'); };
        document.body.appendChild(script);
    }
</script>

<!-- 引入自定义脚本 -->
<script>
    // 当前分析结果
    let currentAnalysis = null;
    
    // 创建策略模态框实例
    const createStrategyModal = new bootstrap.Modal(document.getElementById('createStrategyModal'));
    const executeStrategyModal = new bootstrap.Modal(document.getElementById('executeStrategyModal'));
    
    // 页面加载完成后获取策略列表
    document.addEventListener('DOMContentLoaded', () => {
        refreshPositions();
        refreshStrategies();
        refreshExecutions();
        
        // 设置定时刷新（每30秒刷新一次持仓和市值）
        setInterval(refreshPositions, 30000);
        setInterval(refreshStrategies, 60000);
    });
    
    // 刷新策略列表
    async function refreshStrategies() {
        const button = document.querySelector('button.btn-outline-primary[onclick="refreshStrategies()"]');
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 刷新中...';
        
        try {
            // 不再传递排序参数，使用后端的默认排序逻辑
            const response = await axios.get('/api/v1/strategies');
            
            if (response.data.code === 200) {
                displayStrategies(response.data.data);
            } else {
                showToast('获取策略列表失败：' + response.data.message, 'danger');
            }
        } catch (error) {
            console.error('获取策略列表失败：', error);
            showToast('获取策略列表失败，请查看控制台了解详情', 'danger');
        } finally {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 刷新列表';
        }
    }

    // 搜索策略
    async function searchStrategies() {
        try {
            const params = {
                stock_code: document.getElementById('searchStockCode').value,
                stock_name: document.getElementById('searchStockName').value,
                action: document.getElementById('searchAction').value,
                is_active: document.getElementById('searchStatus').value,
                start_time: document.getElementById('searchStartTime').value,
                end_time: document.getElementById('searchEndTime').value
            };
            
            const queryString = Object.entries(params)
                .filter(([_, value]) => value !== '')
                .map(([key, value]) => `${key}=${encodeURIComponent(value)}`)
                .join('&');
            
            const response = await axios.get(`/api/v1/strategies/search?${queryString}`);
            
            if (response.data.code === 200) {
                displayStrategies(response.data.data);
            } else {
                showToast('搜索策略失败：' + response.data.message, 'danger');
            }
        } catch (error) {
            console.error('搜索策略失败：', error);
            showToast('搜索策略失败，请查看控制台了解详情', 'danger');
        }
    }
    
    // 显示策略列表
    async function displayStrategies(strategies) {
        const container = document.getElementById('strategiesList');
        container.innerHTML = '';
        
        if (strategies.length === 0) {
            container.innerHTML = '<div class="col-12"><div class="alert alert-info">暂无策略数据</div></div>';
            return;
        }
        
        // 显示策略列表
        strategies.forEach(strategy => {
            const card = document.createElement('div');
            card.className = 'col-md-6 col-lg-4 strategy-card';
            card.setAttribute('data-strategy-id', strategy.id);
            
            card.innerHTML = `
                <div class="card ${strategy.is_active ? 'active-strategy' : 'inactive-strategy'}">
                    <div class="card-body">
                        <div class="strategy-header">
                            <h5 class="card-title">${strategy.stock_name}（${strategy.stock_code}）</h5>
                            <span class="${getActionClass(strategy.action)}">
                                ${getActionText(strategy.action)}
                            </span>
                        </div>
                        <p class="card-text">
                            仓位：${strategy.position_ratio.toFixed(0)}%<br>
                            价格区间：${strategy.price_min} - ${strategy.price_max}<br>
                            ${strategy.take_profit_price ? '止盈价：' + strategy.take_profit_price + '<br>' : ''}
                            ${strategy.stop_loss_price ? '止损价：' + strategy.stop_loss_price + '<br>' : ''}
                            ${strategy.other_conditions ? '其他条件：' + strategy.other_conditions + '<br>' : ''}
                            ${strategy.reason ? '理由：' + strategy.reason + '<br>' : ''}
                        </p>
                        <div class="execution-status mb-2">
                            <div class="execution-status-bar 
                                ${strategy.execution_status === 'pending' ? 'status-pending' : 
                                  strategy.execution_status === 'partial' ? 'status-partial' : 
                                  'status-completed'}">
                                ${strategy.execution_status === 'pending' ? '未执行' :
                                  strategy.execution_status === 'partial' ? '部分执行' :
                                  '已完成'}
                            </div>
                        </div>
                        <div class="execution-summary mb-2">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm text-secondary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <small class="text-muted">正在加载执行记录...</small>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="strategy-time">
                                创建：${strategy.created_at}<br>
                                更新：${strategy.updated_at}
                            </div>
                            <div class="btn-group">
                                ${strategy.is_active ? `
                                    <button class="btn btn-sm btn-outline-primary" onclick="showExecuteStrategyModal(${strategy.id})">
                                        <i class="bi bi-play-fill"></i> 执行
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="showEditStrategyModal(${strategy.id})">
                                        <i class="bi bi-pencil"></i> 修改
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deactivateStrategy(${strategy.id})">
                                        <i class="bi bi-x-lg"></i> 失效
                                    </button>
                                ` : `
                                    <button class="btn btn-sm btn-outline-success" onclick="activateStrategy(${strategy.id})">
                                        <i class="bi bi-check-lg"></i> 激活
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(card);
            
            // 异步加载执行记录
            loadStrategyExecutions(strategy.id);
        });
    }

    // 异步加载策略的执行记录
    async function loadStrategyExecutions(strategyId) {
        try {
            const response = await axios.get(`/api/v1/executions?strategy_id=${strategyId}&sort_by=execution_time&order=desc&limit=3`);
            
            const container = document.querySelector(`[data-strategy-id="${strategyId}"] .execution-summary`);
            if (!container) return;
            
            if (response.data.code === 200 && response.data.data.length > 0) {
                const executions = response.data.data;
                container.innerHTML = `
                    <div class="small text-muted">
                        <strong>最近执行：</strong><br>
                        ${executions.map(exec => `
                            <span class="${getResultClass(exec.execution_result)}">
                                ${exec.execution_time} - 
                                ${exec.execution_price}元 × ${exec.volume}股
                                (${getResultText(exec.execution_result)})
                            </span>
                        `).join('<br>')}
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="small text-muted text-center">
                        暂无执行记录
                    </div>
                `;
            }
        } catch (error) {
            console.error('加载执行记录失败：', error);
            const container = document.querySelector(`[data-strategy-id="${strategyId}"] .execution-summary`);
            if (container) {
                container.innerHTML = `
                    <div class="small text-danger text-center">
                        <i class="bi bi-exclamation-circle"></i> 加载失败，请刷新重试
                    </div>
                `;
            }
        }
    }

    // 显示修改策略模态框
    async function showEditStrategyModal(strategyId) {
        try {
            const response = await axios.get(`/api/v1/strategies/${strategyId}`);
            
            if (response.data.code === 200) {
                const strategy = response.data.data;
                document.getElementById('editStrategyId').value = strategy.id;
                document.getElementById('editStockName').value = strategy.stock_name;
                document.getElementById('editStockCode').value = strategy.stock_code;
                document.getElementById('editAction').value = getActionText(strategy.action);
                document.getElementById('editPositionRatio').value = strategy.position_ratio;
                document.getElementById('editPriceMin').value = strategy.price_min || '';
                document.getElementById('editPriceMax').value = strategy.price_max || '';
                document.getElementById('editTakeProfitPrice').value = strategy.take_profit_price || '';
                document.getElementById('editStopLossPrice').value = strategy.stop_loss_price || '';
                document.getElementById('editOtherConditions').value = strategy.other_conditions || '';
                document.getElementById('editReason').value = strategy.reason || '';
                
                const editStrategyModal = new bootstrap.Modal(document.getElementById('editStrategyModal'));
                editStrategyModal.show();
            } else {
                showToast('error', response.data.message || '获取策略详情失败');
            }
        } catch (error) {
            console.error('获取策略详情失败:', error);
            showToast('error', error.response?.data?.message || '获取策略详情失败');
        }
    }

    // 更新策略
    async function updateStrategy() {
        const strategyId = document.getElementById('editStrategyId').value;
        const data = {
            position_ratio: parseFloat(document.getElementById('editPositionRatio').value),
            price_min: parseFloat(document.getElementById('editPriceMin').value) || null,
            price_max: parseFloat(document.getElementById('editPriceMax').value) || null,
            take_profit_price: parseFloat(document.getElementById('editTakeProfitPrice').value) || null,
            stop_loss_price: parseFloat(document.getElementById('editStopLossPrice').value) || null,
            other_conditions: document.getElementById('editOtherConditions').value.trim(),
            reason: document.getElementById('editReason').value.trim()
        };

        // 验证仓位比例
        if (isNaN(data.position_ratio) || data.position_ratio < 0 || data.position_ratio > 100) {
            showToast('error', '请输入有效的仓位比例（0-100之间）');
            return;
        }

        try {
            const updateBtn = document.querySelector('#editStrategyModal .btn-primary');
            setButtonLoading(updateBtn, true);

            const response = await axios.put(`/api/v1/strategies/${strategyId}`, data);
            
            if (response.data.code === 200) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('editStrategyModal'));
                modal.hide();
                await refreshStrategies();
                showToast('success', '策略更新成功');
            } else {
                showToast('error', response.data.message || '策略更新失败');
            }
        } catch (error) {
            console.error('更新策略失败:', error);
            showToast('error', error.response?.data?.message || '更新策略失败');
        } finally {
            const updateBtn = document.querySelector('#editStrategyModal .btn-primary');
            setButtonLoading(updateBtn, false);
        }
    }

    // 刷新执行记录
    async function refreshExecutions() {
        const button = document.querySelector('button.refresh-btn[onclick="refreshExecutions()"]');
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 刷新中...';
        
        try {
            const response = await fetch('/api/v1/executions');
            const result = await response.json();
            
            if (result.code === 200) {
                displayExecutions(result.data);
                updateExecutionLastUpdateTime();
            } else {
                console.error('获取执行记录失败:', result.message);
            }
        } catch (error) {
            console.error('刷新执行记录出错:', error);
        } finally {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 刷新数据';
        }
    }

    function displayExecutions(executions) {
        const container = document.getElementById('executionsList');
        container.innerHTML = '';
        
        if (!executions || executions.length === 0) {
            container.innerHTML = '<div class="alert alert-info">暂无执行记录</div>';
            return;
        }
        
        executions.forEach(execution => {
            const card = renderExecutionCard(execution);
            container.appendChild(card);
        });
    }
    
    function updateExecutionLastUpdateTime() {
        const now = new Date();
        document.getElementById('executionLastUpdateTime').textContent = 
            now.toLocaleString('zh-CN', { hour12: false });
    }

    // 显示创建策略模态框
    function showCreateStrategyModal() {
        // 重置表单和按钮状态
        resetModal();
        // 显示分析按钮
        document.getElementById('analyzeStrategyBtn').classList.remove('d-none');
        // 创建新的模态框实例并显示
        const modal = new bootstrap.Modal(document.getElementById('createStrategyModal'));
        modal.show();
    }

    // 重置模态框
    function resetModal() {
        // 重置表单内容
        document.getElementById('strategyText').value = '';
        document.getElementById('analysisResult').textContent = '';
        
        // 重置按钮状态
        const analyzeBtn = document.getElementById('analyzeStrategyBtn');
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = '分析策略';
        analyzeBtn.classList.remove('d-none');
        
        // 隐藏其他按钮
        document.getElementById('createStrategyBtn').classList.add('d-none');
        document.getElementById('updateStrategyBtn').classList.add('d-none');
        
        // 清空当前分析结果
        currentAnalysis = null;
    }

    // 分析策略
    async function analyzeStrategy() {
        try {
            const strategyText = document.getElementById('strategyText').value;
            if (!strategyText) {
                showToast('error', '请输入策略文本');
                return;
            }

            // 显示加载状态
            const analyzeBtn = document.getElementById('analyzeStrategyBtn');
            setButtonLoading(analyzeBtn, true);

            const response = await axios.post('/api/v1/analyze_strategy', {
                strategy_text: strategyText
            });

            if (response.data.code === 200 && response.data.data) {
                // 保存当前分析结果
                currentAnalysis = response.data.data;
                
                // 在分析结果区域显示 JSON
                const analysisResult = document.getElementById('analysisResult');
                analysisResult.textContent = JSON.stringify(response.data, null, 2);

                // 检查是否存在相同策略
                const checkResponse = await axios.post('/api/v1/strategies/check', {
                    stock_name: currentAnalysis.stock_name,
                    stock_code: currentAnalysis.stock_code,
                    action: currentAnalysis.action
                });

                // 隐藏分析按钮
                document.getElementById('analyzeStrategyBtn').classList.add('d-none');

                if (checkResponse.data.code === 200 && checkResponse.data.data) {
                    // 存在相同策略，显示更新按钮
                    document.getElementById('updateStrategyBtn').classList.remove('d-none');
                    document.getElementById('createStrategyBtn').classList.add('d-none');
                    showToast('info', '已存在相同策略，可以选择更新');
                } else {
                    // 不存在相同策略，显示创建按钮
                    document.getElementById('createStrategyBtn').classList.remove('d-none');
                    document.getElementById('updateStrategyBtn').classList.add('d-none');
                    showToast('success', '策略分析成功，可以创建新策略');
                }
            } else {
                showToast('error', response.data.message || '策略分析失败');
            }
        } catch (error) {
            console.error('分析策略失败:', error);
            showToast('error', error.response?.data?.message || '分析策略失败');
        } finally {
            setButtonLoading(document.getElementById('analyzeStrategyBtn'), false);
        }
    }
    
    // 执行策略
    async function executeStrategy() {
        try {
            const strategyId = document.getElementById('executeStrategyId').value;
            const executionPrice = document.getElementById('executionPrice').value;
            const executionVolume = document.getElementById('executionVolume').value;
            const executionStatus = document.getElementById('executionStatus').value;
            const remarks = document.getElementById('executionRemarks').value;

            // 验证必填字段
            if (!executionPrice || !executionVolume || !executionStatus) {
                showToast('error', '请填写所有必要字段');
                return;
            }

            // 设置按钮加载状态
            const executeBtn = document.querySelector('#executeStrategyModal .btn-primary');
            setButtonLoading(executeBtn, true);

            const response = await axios.post('/api/v1/executions', {
                strategy_id: strategyId,
                execution_price: parseFloat(executionPrice),
                volume: parseInt(executionVolume),
                strategy_status: executionStatus,
                remarks: remarks
            });

            if (response.data.code === 200) {
                showToast('success', '策略执行记录已创建');
                executeStrategyModal.hide();
                
                // 立即刷新策略列表以更新状态
                await refreshStrategies();
                
                // 刷新执行记录
                const card = document.querySelector(`[data-strategy-id="${strategyId}"]`);
                if (card) {
                    await loadStrategyExecutions(strategyId);
                }
                
                // 刷新持仓列表
                await refreshPositions();
                
                // 刷新执行记录列表
                await refreshExecutions();
                
                // 如果当前在执行记录标签页，更新最后更新时间
                updateExecutionLastUpdateTime();
            } else {
                showToast('error', response.data.message || '创建执行记录失败');
            }
        } catch (error) {
            console.error('执行策略失败:', error);
            // 特别处理资金不足的错误
            if (error.response?.data?.message && error.response.data.message.includes('可用资金不足')) {
                let errorMsg = error.response.data.message;
                // 显示更友好的错误信息
                showToast('error', `交易失败：${errorMsg}，请检查账户资金或调整交易量`);
                // 添加详细提示
                showDetailedError('资金不足', 
                    `<p>执行此交易需要的资金超过了您当前的可用资金。</p>
                     <p>您可以：</p>
                     <ul>
                       <li>减少交易数量</li>
                       <li>等待账户资金增加</li>
                       <li>卖出其他持仓以释放资金</li>
                     </ul>`);
            } else {
                showToast('error', error.response?.data?.message || '执行策略失败');
            }
        } finally {
            // 恢复按钮状态
            const executeBtn = document.querySelector('#executeStrategyModal .btn-primary');
            setButtonLoading(executeBtn, false);
        }
    }

    // 显示详细错误信息
    function showDetailedError(title, message) {
        // 如果模态框不存在，创建它
        let errorModal = document.getElementById('detailedErrorModal');
        if (!errorModal) {
            const modalHTML = `
                <div class="modal fade" id="detailedErrorModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title" id="errorModalTitle">错误详情</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="errorModalBody">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            errorModal = document.getElementById('detailedErrorModal');
        }
        
        // 设置模态框内容
        document.getElementById('errorModalTitle').textContent = title;
        document.getElementById('errorModalBody').innerHTML = message;
        
        // 显示模态框
        try {
            if (typeof bootstrap !== 'undefined') {
                const modal = new bootstrap.Modal(errorModal);
                modal.show();
            } else {
                console.error('Bootstrap library not loaded');
                alert(`${title}: ${message.replace(/<[^>]*>/g, '')}`);
            }
        } catch (error) {
            console.error('Error showing modal:', error);
            alert(`${title}: ${message.replace(/<[^>]*>/g, '')}`);
        }
    }

    // 设置策略失效
    async function deactivateStrategy(strategyId) {
        if (!confirm('确定要将此策略设置为失效吗？')) {
            return;
        }

        try {
            const response = await axios.post(`/api/v1/strategies/${strategyId}/deactivate`);
            
            if (response.data.code === 200) {
                refreshStrategies();
                showToast('策略已设置为失效', 'success');
            } else {
                showToast('设置策略失效失败：' + response.data.message, 'danger');
            }
        } catch (error) {
            console.error('设置策略失效失败：', error);
            showToast('设置策略失效失败，请查看控制台了解详情', 'danger');
        }
    }

    // 激活策略
    async function activateStrategy(strategyId) {
        if (!confirm('确定要激活此策略吗？')) {
            return;
        }

        try {
            const response = await axios.post(`/api/v1/strategies/${strategyId}/activate`);
            
            if (response.data.code === 200) {
                refreshStrategies();
                showToast('success', '策略已激活');
            } else {
                showToast('error', response.data.message || '激活策略失败');
            }
        } catch (error) {
            console.error('激活策略失败：', error);
            showToast('error', '激活策略失败，请查看控制台了解详情');
        }
    }

    // 获取执行结果样式类
    function getResultClass(result) {
        switch (result) {
            case 'success': return 'result-success';
            case 'failed': return 'result-failed';
            case 'partial': return 'result-partial';
            default: return '';
        }
    }

    // 获取执行结果文本
    function getResultText(result) {
        switch (result) {
            case 'success': return '执行成功';
            case 'failed': return '执行失败';
            case 'partial': return '部分成功';
            default: return result;
        }
    }

    // 显示提示消息
    function showToast(type, message) {
        // 创建提示元素
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        // 添加到页面
        if (!document.querySelector('.toast-container')) {
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(container);
        }
        
        document.querySelector('.toast-container').appendChild(toast);
        
        // 显示提示
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // 自动移除
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }

    // 添加资金信息更新函数
    async function updateFundInfo() {
        try {
            const response = await fetch('/api/v1/account/funds');
            const data = await response.json();
            if (data.code === 200) {
                document.getElementById('availableFunds').textContent = formatMoney(data.data.available_funds);
                document.getElementById('totalAssets').textContent = formatMoney(data.data.total_assets);
                const profitRatioElement = document.getElementById('totalProfitRatio');
                const profitRatio = data.data.total_profit_ratio;
                profitRatioElement.textContent = formatProfitRatio(profitRatio);
                profitRatioElement.className = 'card-text ' + (profitRatio >= 0 ? 'profit' : 'loss');
            }
        } catch (error) {
            console.error('获取资金信息失败:', error);
        }
    }

    // 格式化金额显示
    function formatMoney(amount) {
        return '¥ ' + parseFloat(amount).toLocaleString('zh-CN', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // 格式化盈亏比例
    function formatProfitRatio(ratio) {
        if (ratio === 999999) return '♾️';
        return ratio.toFixed(2) + '%';
    }

    // 更新持仓列表函数
    async function updatePositionsList(positions) {
        const table = document.querySelector('.position-table');
        const tbody = table.querySelector('tbody') || document.createElement('tbody');
        tbody.innerHTML = '';

        let totalMarketValue = 0;
        let totalFloatingProfit = 0;
        let totalCost = 0;
        let totalVolume = 0;

        positions.forEach(position => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${position.stock_name}</td>
                <td>${position.stock_code}</td>
                <td class="text-end">${position.total_volume}</td>
                <td class="text-end">${formatMoney(position.original_cost)}</td>
                <td class="text-end">${formatMoney(position.dynamic_cost)}</td>
                <td class="text-end">${formatMoney(position.latest_price)}</td>
                <td class="text-end">${formatMoney(position.total_volume * position.dynamic_cost)}</td>
                <td class="text-end">${formatMoney(position.market_value)}</td>
                <td class="text-end ${position.floating_profit >= 0 ? 'profit' : 'loss'}">${formatMoney(position.floating_profit)}</td>
                <td class="text-end ${position.floating_profit_ratio >= 0 ? 'profit' : 'loss'}">${formatProfitRatio(position.floating_profit_ratio)}</td>
            `;
            tbody.appendChild(row);

            // 累计合计数据
            totalMarketValue += parseFloat(position.market_value) || 0;
            totalFloatingProfit += parseFloat(position.floating_profit) || 0;
            totalCost += position.total_volume * position.dynamic_cost;
            totalVolume += position.total_volume;
        });

        // 计算合计行收益率
        const totalProfitRatio = totalCost > 0 ? (totalFloatingProfit / totalCost) * 100 : 0;

        // 添加合计行
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        totalRow.innerHTML = `
            <td colspan="2" class="text-center">合计</td>
            <td class="text-end">${totalVolume}</td>
            <td class="text-end">-</td>
            <td class="text-end">-</td>
            <td class="text-end">-</td>
            <td class="text-end">${formatMoney(totalCost)}</td>
            <td class="text-end">${formatMoney(totalMarketValue)}</td>
            <td class="text-end ${totalFloatingProfit >= 0 ? 'profit' : 'loss'}">${formatMoney(totalFloatingProfit)}</td>
            <td class="text-end ${totalProfitRatio >= 0 ? 'profit' : 'loss'}">${formatProfitRatio(totalProfitRatio)}</td>
        `;
        tbody.appendChild(totalRow);

        if (!table.contains(tbody)) {
            table.appendChild(tbody);
        }

        // 更新最后更新时间
        document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString('zh-CN');
        
        // 更新资金信息
        await updateFundInfo();
    }

    // 刷新持仓列表时同时更新资金信息
    async function refreshPositions() {
        const button = document.querySelector('button.btn-outline-primary');
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 刷新中...';
        
        try {
            const response = await fetch('/api/v1/positions');
            const data = await response.json();
            if (data.code === 200) {
                await updatePositionsList(data.data);
            }
        } catch (error) {
            console.error('刷新持仓失败:', error);
        } finally {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 刷新持仓';
        }
    }

    // 页面加载完成后自动刷新持仓
    document.addEventListener('DOMContentLoaded', refreshPositions);

    // 按钮加载状态控制
    function setButtonLoading(button, isLoading) {
        if (isLoading) {
            // 保存原始文本
            const originalText = button.textContent;
            button.setAttribute('data-original-text', originalText);
            
            // 添加加载样式
            button.classList.add('btn-loading');
            button.disabled = true;
        } else {
            // 恢复原始文本
            const originalText = button.getAttribute('data-original-text');
            if (originalText) {
                button.textContent = originalText;
                button.removeAttribute('data-original-text');
            }
            
            // 移除加载样式
            button.classList.remove('btn-loading');
            button.disabled = false;
        }
    }

    // 为所有表单添加提交事件处理
    document.addEventListener('DOMContentLoaded', function() {
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function(event) {
                const submitButton = form.querySelector('button[type="submit"]');
                if (submitButton) {
                    setButtonLoading(submitButton, true);
                }
            });
        });
    });

    // 为所有按钮添加点击事件处理
    document.addEventListener('DOMContentLoaded', function() {
        const actionButtons = document.querySelectorAll('.btn-action');
        actionButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                if (!button.classList.contains('btn-loading')) {
                    setButtonLoading(button, true);
                    
                    // 在 AJAX 请求完成后恢复按钮状态
                    setTimeout(() => {
                        setButtonLoading(button, false);
                    }, 2000); // 这里的延时应该根据实际 AJAX 请求的完成时间来设置
                }
            });
        });
    });

    // 创建策略
    async function createStrategy() {
        if (!currentAnalysis) {
            showToast('warning', '请先分析策略');
            return;
        }
        
        const createBtn = document.getElementById('createStrategyBtn');
        const updateBtn = document.getElementById('updateStrategyBtn');
        
        try {
            // 设置按钮加载状态
            setButtonLoading(createBtn, true);
            setButtonLoading(updateBtn, true);
            
            // 调用创建策略接口
            const response = await axios.post('/api/v1/strategies', currentAnalysis);
            
            if (response.data.code === 200) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('createStrategyModal'));
                modal.hide();
                refreshStrategies();
                showToast('success', '策略创建成功');
            } else {
                showToast('error', response.data.message || '策略创建失败');
            }
        } catch (error) {
            console.error('策略创建失败：', error);
            showToast('error', error.response?.data?.message || '策略创建失败');
        } finally {
            // 恢复按钮状态
            setButtonLoading(createBtn, false);
            setButtonLoading(updateBtn, false);
        }
    }

    // 分析后更新策略
    async function updateAnalyzedStrategy() {
        if (!currentAnalysis) {
            showToast('warning', '请先分析策略');
            return;
        }
        
        const createBtn = document.getElementById('createStrategyBtn');
        const updateBtn = document.getElementById('updateStrategyBtn');
        
        try {
            // 设置按钮加载状态
            setButtonLoading(createBtn, true);
            setButtonLoading(updateBtn, true);
            
            // 先检查是否存在相同的有效策略
            const checkResponse = await axios.post('/api/v1/strategies/check', {
                stock_name: currentAnalysis.stock_name,
                stock_code: currentAnalysis.stock_code,
                action: currentAnalysis.action
            });
            
            let response;
            if (checkResponse.data.code === 200 && checkResponse.data.data) {
                // 如果存在相同的策略，则调用更新接口
                const existingStrategy = checkResponse.data.data;
                response = await axios.put(`/api/v1/strategies/${existingStrategy.id}`, currentAnalysis);
                if (response.data.code === 200) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createStrategyModal'));
                    modal.hide();
                    refreshStrategies();
                    showToast('success', '已更新现有策略');
                }
            }
        } catch (error) {
            console.error('策略更新失败：', error);
            showToast('error', error.response?.data?.message || '策略更新失败');
        } finally {
            // 恢复按钮状态
            setButtonLoading(createBtn, false);
            setButtonLoading(updateBtn, false);
        }
    }

    // 显示执行策略模态框
    function showExecuteStrategyModal(strategyId) {
        // 重置表单
        document.getElementById('executeStrategyForm').reset();
        // 设置策略ID
        document.getElementById('executeStrategyId').value = strategyId;
        // 显示模态框
        executeStrategyModal.show();
    }

    // 添加全局函数用于获取操作类型的样式和文本
    // 定义一个函数，返回操作类型的样式类名
    function getActionClass(action) {
        switch(action) {
            case 'buy':
                return 'buy-action';
            case 'add':
                return 'add-action';
            case 'sell':
                return 'sell-action';
            case 'trim':
                return 'trim-action';
            case 'hold':
                return 'hold-action';
            default:
                return 'buy-action'; // 默认样式
        }
    }

    // 定义一个函数，返回操作类型的中文文本
    function getActionText(action) {
        switch(action) {
            case 'buy':
                return '买入';
            case 'add':
                return '加仓';
            case 'sell':
                return '卖出';
            case 'trim':
                return '减仓';
            case 'hold':
                return '持有';
            default:
                return action;
        }
    }
    
    // 定义一个函数，返回执行记录卡片的类名
    function getExecutionCardClass(action) {
        switch(action) {
            case 'buy':
                return 'execution-buy';
            case 'add':
                return 'execution-add';
            case 'sell':
                return 'execution-sell';
            case 'trim':
                return 'execution-trim';
            case 'hold':
                return 'execution-hold';
            default:
                return 'execution-buy'; // 默认样式
        }
    }

    // 修改执行记录卡片渲染部分
    function renderExecutionCard(execution) {
        // 计算执行结果对应的样式类
        const resultClass = 
            execution.execution_result === 'success' ? 'success-result' :
            execution.execution_result === 'failed' ? 'failed-result' :
            'partial-result';
        
        // 计算执行结果对应的文本
        const resultText = 
            execution.execution_result === 'success' ? '成功' :
            execution.execution_result === 'failed' ? '失败' :
            '部分';
        
        const card = document.createElement('div');
        card.className = `card execution-card ${getExecutionCardClass(execution.action)}`;
        
        card.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <h5 class="card-title">${execution.stock_name}（${execution.stock_code}）</h5>
                    <span class="${getActionClass(execution.action)}">
                        ${getActionText(execution.action)}
                    </span>
                </div>
                <div class="mb-2">
                    <span class="execution-result ${resultClass}">
                        ${resultText}
                    </span>
                    <span class="execution-time">
                        ${execution.execution_time}
                    </span>
                </div>
                <div class="execution-details">
                    <div>执行价格：<span class="position-number">${execution.execution_price}元</span></div>
                    <div>交易量：<span class="position-number">${execution.volume}股</span></div>
                    <div>策略ID：${execution.strategy_id}</div>
                    ${execution.remarks ? `<div>备注：${execution.remarks}</div>` : ''}
                </div>
            </div>
        `;
        
        return card;
    }
</script>
</body>
</html> 