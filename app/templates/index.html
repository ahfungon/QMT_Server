<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QMT Server - 股票交易策略管理</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入自定义样式 -->
    <style>
        .strategy-card {
            margin-bottom: 1rem;
        }
        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .strategy-time {
            font-size: 0.9rem;
            color: #666;
        }
        .buy-action {
            color: #d9534f;
        }
        .sell-action {
            color: #5cb85c;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="text-center mb-4">股票交易策略管理</h1>
        
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button class="btn btn-primary me-2" onclick="refreshStrategies()">刷新列表</button>
                        <select class="form-select d-inline-block w-auto" id="sortSelect" onchange="refreshStrategies()">
                            <option value="updated_at">按更新时间</option>
                            <option value="created_at">按创建时间</option>
                        </select>
                        <select class="form-select d-inline-block w-auto ms-2" id="orderSelect" onchange="refreshStrategies()">
                            <option value="desc">降序</option>
                            <option value="asc">升序</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="showCreateStrategyModal()">新建策略</button>
                </div>
            </div>
        </div>

        <div id="strategiesList" class="row">
            <!-- 策略列表将通过 JavaScript 动态加载 -->
        </div>
    </div>

    <!-- 新建策略模态框 -->
    <div class="modal fade" id="createStrategyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新建策略</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createStrategyForm">
                        <div class="mb-3">
                            <label class="form-label">策略文本</label>
                            <textarea class="form-control" id="strategyText" rows="3" required></textarea>
                            <div class="form-text">请输入自然语言的策略描述，例如："以30元买入平安银行，仓位30%"</div>
                        </div>
                    </form>
                </div>
                <div class="modal-body" id="analysisResult" style="display: none;">
                    <h6>策略解析结果：</h6>
                    <pre id="analysisJson" class="bg-light p-3 rounded"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="analyzeStrategy()">分析策略</button>
                    <button type="button" class="btn btn-success" onclick="createStrategy()" style="display: none;" id="createStrategyBtn">确认创建</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入必要的 JavaScript 库 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.2/axios.min.js"></script>
    
    <!-- 引入自定义脚本 -->
    <script>
        // 当前分析结果
        let currentAnalysis = null;
        
        // 创建策略模态框实例
        const createStrategyModal = new bootstrap.Modal(document.getElementById('createStrategyModal'));
        
        // 页面加载完成后获取策略列表
        document.addEventListener('DOMContentLoaded', () => {
            refreshStrategies();
        });
        
        // 刷新策略列表
        async function refreshStrategies() {
            try {
                const sortBy = document.getElementById('sortSelect').value;
                const order = document.getElementById('orderSelect').value;
                const response = await axios.get(`/api/v1/strategies?sort_by=${sortBy}&order=${order}`);
                
                if (response.data.code === 200) {
                    displayStrategies(response.data.data);
                } else {
                    alert('获取策略列表失败：' + response.data.message);
                }
            } catch (error) {
                console.error('获取策略列表失败：', error);
                alert('获取策略列表失败，请查看控制台了解详情');
            }
        }
        
        // 显示策略列表
        function displayStrategies(strategies) {
            const container = document.getElementById('strategiesList');
            container.innerHTML = '';
            
            strategies.forEach(strategy => {
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4 strategy-card';
                card.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <div class="strategy-header">
                                <h5 class="card-title">${strategy.stock_name}（${strategy.stock_code}）</h5>
                                <span class="${strategy.action === 'buy' ? 'buy-action' : 'sell-action'}">
                                    ${strategy.action === 'buy' ? '买入' : '卖出'}
                                </span>
                            </div>
                            <p class="card-text">
                                仓位：${(strategy.position_ratio * 100).toFixed(0)}%<br>
                                价格区间：${strategy.price_min} - ${strategy.price_max}<br>
                                ${strategy.take_profit_price ? '止盈价：' + strategy.take_profit_price + '<br>' : ''}
                                ${strategy.stop_loss_price ? '止损价：' + strategy.stop_loss_price + '<br>' : ''}
                                ${strategy.other_conditions ? '其他条件：' + strategy.other_conditions + '<br>' : ''}
                                ${strategy.reason ? '理由：' + strategy.reason : ''}
                            </p>
                            <div class="strategy-time">
                                创建：${strategy.created_at}<br>
                                更新：${strategy.updated_at}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // 显示创建策略模态框
        function showCreateStrategyModal() {
            document.getElementById('strategyText').value = '';
            document.getElementById('analysisResult').style.display = 'none';
            document.getElementById('createStrategyBtn').style.display = 'none';
            document.getElementById('analysisJson').textContent = '';
            currentAnalysis = null;
            createStrategyModal.show();
        }
        
        // 分析策略
        async function analyzeStrategy() {
            const strategyText = document.getElementById('strategyText').value.trim();
            if (!strategyText) {
                alert('请输入策略文本');
                return;
            }
            
            try {
                const response = await axios.post('/api/v1/analyze_strategy', {
                    strategy_text: strategyText
                });
                
                if (response.data.code === 200) {
                    currentAnalysis = response.data.data;
                    document.getElementById('analysisJson').textContent = JSON.stringify(currentAnalysis, null, 2);
                    document.getElementById('analysisResult').style.display = 'block';
                    document.getElementById('createStrategyBtn').style.display = 'inline-block';
                } else {
                    alert('策略分析失败：' + response.data.message);
                }
            } catch (error) {
                console.error('策略分析失败：', error);
                alert('策略分析失败，请查看控制台了解详情');
            }
        }
        
        // 创建策略
        async function createStrategy() {
            if (!currentAnalysis) {
                alert('请先分析策略');
                return;
            }
            
            try {
                const response = await axios.post('/api/v1/strategies', currentAnalysis);
                
                if (response.data.code === 200) {
                    createStrategyModal.hide();
                    refreshStrategies();
                    alert('策略创建成功');
                } else {
                    alert('策略创建失败：' + response.data.message);
                }
            } catch (error) {
                console.error('策略创建失败：', error);
                alert('策略创建失败，请查看控制台了解详情');
            }
        }
    </script>
</body>
</html> 